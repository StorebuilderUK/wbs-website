---
import { findLinkOpportunities, generateLinkInsertionCode } from '../utils/linkAnalyzer.js';

const { currentPost, allPosts } = Astro.props;

// Get the rendered content as text for analysis
const { Content } = await currentPost.render();
const contentText = currentPost.body || '';

// Find link opportunities
const opportunities = findLinkOpportunities(contentText, allPosts, currentPost.slug);
---

{opportunities.length > 0 && (
  <div class="mt-12 p-6 bg-blue-50 rounded-lg border border-blue-200">
    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
      <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
      </svg>
      Internal Link Suggestions
    </h3>
    
    <p class="text-sm text-gray-600 mb-4">
      Boost SEO by adding these relevant internal links to your content:
    </p>
    
    <div class="space-y-4" id="link-suggestions">
      {opportunities.map((opp, index) => (
        <div class="bg-white p-4 rounded-md border border-blue-100" data-opportunity-index={index}>
          <div class="flex items-start justify-between mb-2">
            <h4 class="font-medium text-gray-900">
              Link to: <a href={`/blog/${opp.post.slug}`} class="text-blue-600 hover:underline" target="_blank">
                {opp.post.data.title}
              </a>
            </h4>
            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
              Score: {opp.relevanceScore}
            </span>
          </div>
          
          <div class="space-y-2">
            {opp.anchorOpportunities.slice(0, 2).map((anchor, anchorIndex) => {
              const linkCode = generateLinkInsertionCode(anchor);
              return (
                <div class="text-sm bg-gray-50 p-3 rounded" data-anchor-index={anchorIndex}>
                  <p class="text-gray-600 mb-2">
                    <strong>Context:</strong> "...{anchor.sentence}..."
                  </p>
                  <p class="text-gray-600 mb-2">
                    <strong>Suggested anchor:</strong> 
                    <span class="font-mono bg-yellow-100 px-1">{anchor.anchorText}</span>
                  </p>
                  <div class="mt-2 flex gap-2">
                    <button
                      class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 copy-markdown"
                      data-markdown={linkCode.markdown}
                    >
                      Copy Markdown
                    </button>
                    <button
                      class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 copy-html"
                      data-html={linkCode.updated}
                    >
                      Copy HTML
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
          
          <div class="mt-2 text-xs text-gray-500">
            Common keywords: {opp.commonKeywords.join(', ')}
          </div>
        </div>
      ))}
    </div>
    
    <div class="mt-4 text-sm text-gray-600">
      <p><strong>Pro tip:</strong> Add 2-3 internal links per article for best SEO results.</p>
    </div>
  </div>
)}

<script>
  // Copy functionality
  document.querySelectorAll('.copy-markdown').forEach(button => {
    button.addEventListener('click', () => {
      const markdown = button.getAttribute('data-markdown');
      navigator.clipboard.writeText(markdown).then(() => {
        button.textContent = 'Copied!';
        setTimeout(() => {
          button.textContent = 'Copy Markdown';
        }, 2000);
      });
    });
  });
  
  document.querySelectorAll('.copy-html').forEach(button => {
    button.addEventListener('click', () => {
      const html = button.getAttribute('data-html');
      navigator.clipboard.writeText(html).then(() => {
        button.textContent = 'Copied!';
        setTimeout(() => {
          button.textContent = 'Copy HTML';
        }, 2000);
      });
    });
  });
</script>